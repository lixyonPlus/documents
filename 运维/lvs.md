# LVS的结构主要分为两部分：
    工作在内核空间的IPVS模块。LVS的能力实际上都是由IVPS模块实现。
    工作在用户空间的ipvsadm管理工具。其作用是向用户提供一个命令接口，用于将配置的虚拟服务、真实服务等传给IPVS模块。
    要使用LVS的能力，只需安装一个LVS的管理工具：ipvsadm

### LVS三种模式:
    NAT模式（VS-NAT）
        原理：就是把客户端发来的数据包的IP头的目的地址，在负载均衡器上换成其中一台RS的IP地址，并发至此RS来处理,RS处理完成后把数据交给经过负载均衡器,负载均衡器再把数据包的原IP地址改为自己的IP，将目的地址改为客户端IP地址即可期间,无论是进来的流量,还是出去的流量,都必须经过负载均衡器（即修改来去的目标IP和MAC地址）
        优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，只有负载均衡器需要一个合法的IP地址。
        缺点：扩展性有限。当服务器节点（普通PC服务器）数据增长到20个或更多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包都需要经过负载均衡器再生。假使TCP包的平均长度是536字节的话，平均包再生延迟时间大约为60us（在Pentium处理器上计算的，采用更快的处理器将使得这个延迟时间变短），负载均衡器的最大容许能力为8.93M/s，假定每台物理服务器的平台容许能力为400K/s来计算，负责均衡器能为22台物理服务器计算。
    直接路由模式（VS-DR）
        原理：负载均衡器和RS都使用同一个IP对外服务但只有DR对ARP请求进行响应,所有RS对本身这个IP的ARP请求保持静默也就是说,网关会把对这个服务IP的请求全部定向给DR,而DR收到数据包后根据调度算法,找出对应的RS,把目的MAC地址改为RS的MAC（因为IP一致）并将请求分发给这台RS这时RS收到这个数据包,处理完成之后，由于IP一致，可以直接将数据返给客户，则等于直接从客户端收到这个数据包无异,处理后直接返回给客户端由于负载均衡器要对二层包头进行改换,所以负载均衡器和RS之间必须在一个广播域,也可以简单的理解为在同一台交换机上
        优点：和TUN（隧道模式）一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器。
        缺点：（不能说缺点，只能说是不足）要求负载均衡器的网卡必须与物理网卡在一个物理段上。
    IP隧道模式（VS-TUN）s
        原理：首先要知道，互联网上的大多Internet服务的请求包很短小，而应答包通常很大。那么隧道模式就是，把客户端发来的数据包，封装一个新的IP头标记(仅目的IP)发给RS,RS收到后,先把数据包的头解开,还原数据包,处理后,直接返回给客户端,不需要再经过负载均衡器注意,由于RS需要对负载均衡器发过来的数据包进行还原,所以说必须支持IPTUNNEL协议所以,在RS的内核中,必须编译支持IPTUNNEL这个选项
        优点：负载均衡器只负责将请求包分发给后端节点服务器，而RS将应答包直接发给用户。所以，减少了负载均衡器的大量数据流动，负载均衡器不再是系统的瓶颈，就能处理很巨大的请求量，这种方式，一台负载均衡器能够为很多RS进行分发。而且跑在公网上就能进行不同地域的分发。
        缺点：隧道模式的RS节点需要合法IP，这种方式需要所有的服务器支持”IP Tunneling”(IP Encapsulation)协议，服务器可能只局限在部分Linux系统上。


### ipvsadm工具常用的参数选项有：
    | name       |       全称       |                       描述                       |
    | ---------- | :--------------: | :----------------------------------------------: |
    | -A         |  --add-service   |               添加一条新的虚拟服务               |
    | -E         |  --edit-service  |                   编辑虚拟服务                   |
    | -D         | --delete-service |                   删除虚拟服务                   |
    | -C         |     --clear      |              清除所有的虚拟服务规则              |
    | -R         |    --restore     |                 恢复虚拟服务规则                 |
    | -a         |   --add-server   |      在一个虚拟服务中添加一个新的真实服务器      |
    | -e         |  --edit-server   |                编辑某个真实服务器                |
    | -d         | --delete-server  |                删除某个真实服务器                |
    | -L         |   -l   --list    |             显示内核中的虚拟服务规则             |
    | -n         |    --numeric     |               以数字形式显示IP端口               |
    | -c         |   --connection   | 显示ipvs中目前存在的连接，也可以用于分析调度情况 |
    | -Z         |      --zero      |               将转发消息的统计清零               |
    | -p         |   --persistent   |                  配置持久化时间                  |
    | --set      |  tcp tcpfin udp  |        配置三个超时时间（tcp/tcpfin/udp）        |
    | -t、-u     |                  |              TCP/UDP协议的虚拟服务               |
    | -g、-m、-i |                  |            LVS模式为：DR、NAT 、 TUN             |
    | -w         |                  |               配置真实服务器的权重               |
    | -s         |                  |        配置负载均衡算法，如:rr, wrr, lc等        |
    | --timeout  |                  |         显示配置的tcp/tcpfin/udp超时时间         |
    | --stats    |                  |          显示历史转发消息统计（累加值）          |
    | --rate     |                  |            显示转发速率信息（瞬时值）            |

### 1. 管理虚拟服务
    添加一个虚拟服务192.168.1.100:80，使用轮询算法
    　　ipvsadm -A -t 192.168.1.100:80 -s rr
    修改虚拟服务的算法为加权轮询
    　　ipvsadm -E -t 192.168.1.100:80 -s wrr
    删除虚拟服务
    　　ipvsadm -D -t 192.168.1.100:80

### 2. 管理真实服务
    添加一个真实服务器192.168.1.123，使用DR模式，权重2
　　    ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.123 -g -w 2
    修改真实服务器的权重
　　    ipvsadm -e -t 192.168.1.100:80 -r 192.168.1.123 -g -w 5
    删除真实服务器
　　    ipvsadm -d -t 192.168.1.100:80 -r 192.168.1.123

### 3.查看统计
    查看当前配置的虚拟服务和各个RS的权重
　　    ipvsadm -Ln
    查看当前ipvs模块中记录的连接（可用于观察转发情况）
　　    ipvsadm -lnc
    查看ipvs模块的转发情况统计
　　    ipvsadm -Ln --stats | --rate

### --stats和--rate统计在分析问题时经常用到，输出各项的含义
    --stat选项是统计自该条转发规则生效以来的包  
    1. Conns    (connections scheduled)  已经转发过的连接数  
    2. InPkts   (incoming packets)       入包个数  
    3. OutPkts  (outgoing packets)       出包个数  
    4. InBytes  (incoming bytes)         入流量（字节）    
    5. OutBytes (outgoing bytes)         出流量（字节） 
    
    --rate选项是显示速率信息  
    1. CPS      (current connection rate)   每秒连接数  
    2. InPPS    (current in packet rate)    每秒的入包个数  
    3. OutPPS   (current out packet rate)   每秒的出包个数  
    4. InBPS    (current in byte rate)      每秒入流量（字节）  
    5. OutBPS   (current out byte rate)     每秒入流量（字节） 
