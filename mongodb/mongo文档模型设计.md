### 关于JSON文档模型设计
- 文档模型设计处于是物理模型设计阶段 (PDM) 
- JSON 文档模型通过内嵌数组或引用字段来表示关系 
- 文档模型设计不遵从第三范式，允许冗余。

### 关系模型 vs 文档模型
| ---          | 关系数据库                 | JSON 文档模型      |
| ------------ | -------------------------- | ------------------ |
| 模型设计层次 | 概念模型/逻辑模型/物理模型 | 概念模型/逻辑模型  |
| 模型实体     | 表                         | 集合               |
| 模型属性     | 列                         | 字段               |
| 模型关系     | 关联关系，主外键           | 内嵌数组，引用字段 |


### 1-1关系建模
- 一对一关系以内嵌为主 
- 作为子文档形式或者直接在顶级 
- 不涉及到数据冗余
- $\color{red}{注意:如果内嵌后导致文档大小超过16MB应该使用引用关联}$

### 1-n关系建模
- 一对多关系同样以内嵌为主
- 用数组来表示一对多
- 不涉及到数据冗余
- $\color{red}{注意:内嵌后导致文档大小超过16MB 数组长度太大(数万或更多) 数组长度不确定,或者频繁更新应该使用引用关联}$

### n-n关系建模 内嵌数组模式
- 不需要映射表 
- 一般用内嵌数组来表示一对多 
- 通过冗余来实现N-N
- $\color{red}{注意:内嵌后导致文档大小超过16MB 数组长度太大(数万或更多) 数组长度不确定,或者频繁更新应该使用引用关联}$

### 使用引用关联，什么时候该使用引用方式?
- 内嵌文档太大，数MB或者超过16MB
- 内嵌文档或数组元素会频繁修改
- 内嵌数组元素会持续增长并且没有封顶
- 类似于关系型设计
- 用id或者唯一键关联
- 使用$lookup来提供一次查询多表的能力(类似关联)

### 大文档，很多字段，很多索引？可以使用列转行的模式设计

### 模型灵活了，如何管理文档不同版本? 增加一个版本字段

### 每访问一个页面都会产生一次数据库计数更新操作统计数字准确性并不十分重要,写入太频繁，消耗系统资源？用近似计算[{$inc:{"views":100}}]

### 业绩排名，游戏排名，商品统计等精确统计,消耗资源多，聚合计算时间长?用预聚合字段[模型中直接增加统计字段,每次更新数据时候同时更新统计值]
```javascript
//以前
{
  product: ”Bike",
  sku: “abc123456”,
  quantitiy: 20394,
  daily_sales: 40,
  weekly_sales: 302,
  monthly_sales: 1419
}
//现在
db.inventory.update({_id:123},{$inc: {quantity: -1, daily_sales: 1, weekly_sales: 1， monthly_sales: 1}})
```

### 引用设计注意
- MongoDB对使用引用的集合之间并无主外键检查MongoDB 
- 使用聚合框架的$lookup来模仿关联查询 
- $lookup只支持left outer join
- $lookup 的关联目标(from)不能是分片表
  
```javascript
//查询联系人及分组
db.contacts.aggregate([
   {
    $lookup:
        {
        from: "groups",
        localField: "group_ids",
        foreignField: "group_id",
        as: "groups"
    }}
])
```

### 建模总结
- 90:10规则: 大部分时候你会使用内嵌来表示 1-1，1-N，N-N 
- 内嵌类似于预先聚合(关联) 
- 内嵌后对读操作通常有优势(减少关联)

